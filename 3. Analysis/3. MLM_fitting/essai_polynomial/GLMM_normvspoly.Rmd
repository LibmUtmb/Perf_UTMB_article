---
title: "Generalized Linear Mixed Model on trail running sex-distance-level speed difference"
subtitle: 'On relative speed pairs selection - visualisation'
author: "Franck LE MAT"
date: "03/02/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(data.table)
library(pander)
library(xtable)
library(scales)
library(car)
library(ggsci)
library(glmmTMB)
library(MuMIn)
library(ggeffects)
library(emmeans)

######################
## Dataset load 
######################

setwd("~/Project _dataScience/UTMB_dataMining/3. Analysis/")
race_result <- fread('DRV_result.csv')

select_coureur_relatif <- fread('3. MLM_fitting/pair_MLM_4%_unique.csv')

######################
## Variable encoding
######################

df <- inner_join(race_result,
                 select_coureur_relatif,
                 by = c("id_course_annee", "id_coureur"))

df <- df %>%
  filter((id_pair != 639) & (id_pair != 214))

df <- df %>%
  group_by(id_coureur,annee) %>%
  mutate(id_coureur_annee = cur_group_id()) %>%
  ungroup() %>%
  transform(id_coureur_annee = as.factor(id_coureur_annee),
            id_course_annee = as.factor(id_course_annee),
            id_pair = as.factor(id_pair),
            sexe = as.factor(sexe)) %>%
  mutate(sexe = factor(sexe, levels = c('H', 'F')))
levels(df$sexe) <- c('M', 'F')

class_building <- function(x){
  
  # We select 'short' distance race, meaning race from 25 to 45 km effort
  df_rank <- x %>%
    filter(km_effort >= 25 & km_effort <= 45) %>%
    group_by(id_pair) %>%
    summarise(vitesse_moy_kmE = mean(km_effort)/mean(temps_s/3600), 
              vitesse_moy = mean(vitesse_moy), 
              km_effort = mean(km_effort))
  
  # We create a linear model with those race's speed 
  l_model <- lm(vitesse_moy_kmE ~ km_effort, data = df_rank)
  
  # We adjust the speed in function of the beta coefficient of the linear model
  rank <- df_rank %>% 
    mutate(vitesse_moy_adj = (l_model$coefficients[2]
                              * (km_effort - min(km_effort)))
           + vitesse_moy_kmE)
  
  # We calculate the quartile of the adjuted speed.
  # Each quartile represent a level classification 
  rank <- rank %>%
    mutate(class = cut(x = vitesse_moy_adj, 
                       breaks = quantile(rank$vitesse_moy_adj,
                                         probs = seq(0, 1, 1/4)), 
                       labels = c("Q4", "Q3", "Q2", "Q1"), 
                       include.lowest = TRUE)) %>%
    dplyr::select("id_pair", "class") %>%
    mutate(class = factor(class, levels = c("Q1", "Q2", "Q3", "Q4"))) %>%
    distinct()
  
  x <- x %>%
    inner_join(rank, by = "id_pair")
  return(x)
}

df <- class_building(df)

```

## Dataset description

```{r description, echo = FALSE}
description <- df %>%
  group_by(class,sexe) %>%
  summarise(nbr_runner = n(), 
            mean_speed = paste(round(mean(vitesse_moy, na.rm = TRUE), 2), '+/-', round(sd(vitesse_moy), 2)), 
            median_rank_scratch = median(place, na.rm = TRUE), 
            mean_cote = paste(round(mean(cote, na.rm = TRUE), 2), '+/-', round(sd(cote, na.rm = TRUE), 2)), 
            age = paste(round(mean(age, na.rm = TRUE), 2), '+/-', round(sd(age), 2)), 
            .groups = 'drop')
pander(description, caption = 'descriptive analysis of runner per level')

```

## Model fitting

Here you have the summary for each model. The first correspond to the 'classic' one and the second to the 'quadratic' one.

```{r model fitting, echo=FALSE}
model <- glmmTMB(vitesse_moy ~ poly(km_effort, 1) 
                 + sexe 
                 + class 
                 + poly(km_effort, 1):sexe 
                 + poly(km_effort, 1):class 
                 + poly(km_effort, 1):class:sexe
                 + (1|id_coureur_annee)
                 + (1|id_pair)
                 + (1|id_course_annee),
                data = df, 
                family=Gamma(link="log"), 
                control = glmmTMBControl(parallel = 7))

model_bis <- glmmTMB(vitesse_moy ~ poly(km_effort, 2)
                     + sexe
                     + class
                     + poly(km_effort, 2):sexe 
                     + poly(km_effort, 2):class 
                     + poly(km_effort, 2):class:sexe
                     + (1|id_coureur_annee)
                     + (1|id_pair)
                     + (1|id_course_annee),
                    data = df, 
                    family=Gamma(link="log"), 
                    control = glmmTMBControl(parallel = 7))

summary(model)

summary(model_bis)

pander(AIC(model, model_bis))

```

## Results sex comparison
### Visualisation

```{r result viz, echo = FALSE, fig.width=20, fig.height=8}
library(ggeffects)

model_list <- list(model, model_bis)

model_plot <- list()

for(m in 1:length(model_list)) {

  mydf <- ggpredict(model_list[[m]],
                    terms = c("km_effort [all]", "sexe"))
  
  model_plot[[m]] <- ggplot(mydf,
                            aes(x,
                                predicted)) +
    geom_line(aes(colour = group)) +
    geom_ribbon(aes(ymin = conf.low,
                    ymax = conf.high,
                    fill = group),
                alpha = .1,
                show.legend=FALSE) +
    labs(y = "Speed (km/h)",
         x = "km effort (a.u.)",
         colour = "Gender",
         title = "Marginal effect of sexe and km effort on speed",
         subtitle = ifelse(m == 1, 'normal model', 'quadratic model')) +
    scale_x_continuous(breaks = pretty_breaks()) + 
    scale_y_continuous(breaks = pretty_breaks()) +
    scale_fill_lancet() +
    scale_color_lancet() +
    theme_classic()
}

ggpubr::ggarrange(plotlist = model_plot, align = 'hv', ncol = 2, labels = 'AUTO', common.legend = TRUE, legend = 'left')

```

If I voluntary push the prediction to 600 km effort, here is the curve shape. 

```{r, echo = FALSE, fig.width=20, fig.height=8, warning=FALSE}
library(ggeffects)

model_list <- list(model, model_bis)

model_plot <- list()

for(m in 1:length(model_list)) {

  mydf <- ggpredict(model_list[[m]],
                    terms = c("km_effort [0:600]", "sexe"))
  
  model_plot[[m]] <- ggplot(mydf,
                            aes(x,
                                predicted)) +
    geom_line(aes(colour = group)) +
    geom_ribbon(aes(ymin = conf.low,
                    ymax = conf.high,
                    fill = group),
                alpha = .1,
                show.legend=FALSE) +
    labs(y = "Speed (km/h)",
         x = "km effort (a.u.)",
         colour = "Gender",
         title = "Marginal effect of sexe and km effort on speed",
         subtitle = ifelse(m == 1, 'normal model', 'quadratic model')) +
    scale_x_continuous(breaks = pretty_breaks()) + 
    scale_y_continuous(breaks = pretty_breaks()) +
    scale_fill_lancet() +
    scale_color_lancet() +
    theme_classic()
}

ggpubr::ggarrange(plotlist = model_plot, align = 'hv', ncol = 2, labels = 'AUTO', common.legend = TRUE, legend = 'left')

```

### Estimates & confidence interval

```{r , echo = FALSE}
library(emmeans)

emm <- emmeans(model, pairwise~sexe|poly(km_effort, 1),
               type = "response",
               at = list(km_effort = c(25, 45, 75, 115, 155, 210, 260)))
ss <- summary(emm)

pander(ss$emmeans, 'normal model')
```

```{r , echo = FALSE}
library(emmeans)

emm <- emmeans(model_bis, pairwise~sexe|poly(km_effort, 1),
               type = "response",
               at = list(km_effort = c(25, 45, 75, 115, 155, 210, 260)))
ss <- summary(emm)

pander(ss$emmeans, 'quadratic model')
```

## Results Ssex and class comparison
### Visualisation

```{r result viz2, echo = FALSE, fig.width=20, fig.height=8}
library(ggeffects)

model_list <- list(model, model_bis)

model_plot <- list()

for(m in 1:length(model_list)) {

  mydf <- ggpredict(model_list[[m]],
                    terms = c("km_effort [all]", "sexe", "class"))
  
  model_plot[[m]] <- ggplot(mydf,
                            aes(x,
                                predicted)) +
    geom_line(aes(colour = group)) +
    geom_ribbon(aes(ymin = conf.low,
                    ymax = conf.high,
                    fill = group),
                alpha = .1,
                show.legend=FALSE) +
    labs(y = "Speed (km/h)",
         x = "km effort (a.u.)",
         colour = "Gender",
         title = "Marginal effect of sexe, level and km effort on speed",
         subtitle = ifelse(m == 1, 'normal model', 'quadratic model')) +
    scale_x_continuous(breaks = pretty_breaks()) + 
    scale_y_continuous(breaks = pretty_breaks()) +
    scale_fill_lancet() +
    scale_color_lancet() +
    theme_classic() +
    facet_wrap(~facet)
}

ggpubr::ggarrange(plotlist = model_plot, align = 'hv', ncol = 2, labels = 'AUTO', common.legend = TRUE, legend = 'left')

```

If I voluntary push the prediction to 600 km effort, here is the curve shape. 

```{r, echo = FALSE, fig.width=20, fig.height=8, warning=FALSE}
library(ggeffects)

model_list <- list(model, model_bis)

model_plot <- list()

for(m in 1:length(model_list)) {

  mydf <- ggpredict(model_list[[m]],
                    terms = c("km_effort [0:600]", "sexe", "class"))
  
  model_plot[[m]] <- ggplot(mydf,
                            aes(x,
                                predicted)) +
    geom_line(aes(colour = group)) +
    geom_ribbon(aes(ymin = conf.low,
                    ymax = conf.high,
                    fill = group),
                alpha = .1,
                show.legend=FALSE) +
    labs(y = "Speed (km/h)",
         x = "km effort (a.u.)",
         colour = "Gender",
         title = "Marginal effect of sexe, level and km effort on speed",
         subtitle = ifelse(m == 1, 'normal model', 'quadratic model')) +
    scale_x_continuous(breaks = pretty_breaks()) + 
    scale_y_continuous(breaks = pretty_breaks()) +
    scale_fill_lancet() +
    scale_color_lancet() +
    theme_classic() +
    facet_wrap(~facet)
}

ggpubr::ggarrange(plotlist = model_plot, align = 'hv', ncol = 2, labels = 'AUTO', common.legend = TRUE, legend = 'left')

```

### Estimates & confidence interval

```{r , echo = FALSE}
library(emmeans)

emm <- emmeans(model, pairwise~sexe*class|poly(km_effort, 1),
               type = "response",
               at = list(km_effort = c(25, 45, 75, 115, 155, 210, 260)))
ss <- summary(emm)

pander(ss$emmeans, 'normal model')
```

```{r , echo = FALSE}
library(emmeans)

emm <- emmeans(model_bis, pairwise~sexe*class|poly(km_effort, 1),
               type = "response",
               at = list(km_effort = c(25, 45, 75, 115, 155, 210, 260)))
ss <- summary(emm)

pander(ss$emmeans, 'quadratic model')
```
