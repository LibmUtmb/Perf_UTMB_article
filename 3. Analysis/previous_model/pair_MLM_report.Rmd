---
title: "pair_MLM"
author: "Franck LE MAT"
date: "29/09/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(funModeling)
library(pander)
library(scales)
library(lme4)
library(scattermore)

memory.limit(size = 99999999) #Increasing the memory use of Rstudio otherwise it take to much time (Windows only)

######################
## Dataset load 
######################

setwd("~/Project _dataScience/UTMB_dataMining/3. Analysis/pairing_MLM/")
dataset <- fread("data_MLM_60s_unique.csv")
dataset <- dataset %>%
  mutate(dist_short = factor(dist_short, levels = c("[25,45)", "[45,75)", "[75,115)", "[115,155)", "[155,210)")),
         diff = diff*100)
dataset <- dataset %>%
  group_by(M, W, annee, dist_short) %>%
  mutate(dist = ifelse(km_effort == min(km_effort), "short", "long")) %>%
  ungroup()

```

## Méthode 1 bis (filtre < 60s + pair unique) 

Visualisation de la dispersion de la variable différence de vitesse (%) en fonction des catégories de km effort. 
```{r data dispersion, echo = FALSE}
ggplot(dataset, aes(x = dist_short, y = diff, color = dist)) + 
  geom_boxplot()

ggplot(dataset, aes(x = diff, fill = dist)) + 
  geom_histogram(binwidth = 10) +
  facet_wrap(~dist_short, ncol = 3, scales = 'free')
```


Scatter plot de la différence de vitesse en fonction du km effort:

```{r scatter plot, echo=FALSE}
p1 <- ggplot(dataset, aes(x = km_effort, y = diff)) +
  geom_scattermore(alpha = .5) +
  scale_x_continuous(breaks =  breaks_pretty()) +
  scale_y_continuous(breaks = breaks_pretty()) +
  labs(y = "Men/women percentage difference", x = "Distance") +
  facet_wrap(~dist_short, ncol = 3) + 
  geom_smooth(method = "glm") +
  geom_smooth(color = "red") +
  theme_classic() 
  
print(p1)
```

## Creation d'un modèle pour chaque catégorie de km effort

We  used  R  (R  Core  Team,  2012)  and  lme4  (Bates,  Maechler  &  Bolker, 2012) to perform a linear mixed effects analysis of the relationship between  men vs women speed difference  and  race's km effort.  As  fixed  effects,  we  entered  km effort  into  the  model.  As  random  effects,  we had  intercepts  for  subjects. P-values were  obtained  by  likelihood  ratio  tests  of  the  full model  with  the  effect  in  question  against  the  model  without  the  effect  in question. *Visual  inspection  of  residual plots  have been checked to reveal any obvious deviations  from  homoscedasticity  or normality.*

### [25,45)

```{r model1, echo=TRUE}
#"[25,45)", "[45,75)", "[75,115)", "[115,155)", "[155,210)"

dataset_f <- dataset %>% filter(dist_short == "[25,45)")

lme1 <- lmer(diff ~ km_effort  + (1 +  km_effort| id)  , data = dataset_f, REML = FALSE)
lme1.null <- lmer(diff ~ 1  + (1 | id), data = dataset_f, REML = FALSE)

rslt <- anova(lme1.null, lme1)

pander(rslt)

summary(lme1)
coef(lme1)

library(DHARMa)
resid_sim <- simulateResiduals(lme1)
plot(resid_sim)

re <- ranef(lme1)$id

qqnorm(re$`(Intercept)`)
qqline(re$`(Intercept)`)

library(MuMIn)
r.squaredGLMM(lme1)

```


```{r model1_variance, echo=FALSE}
dataset_f$fit<- as.numeric(fitted(lme1))
dataset_f$res <- as.numeric(residuals(lme1))
ggplot(dataset_f, aes(x = fit, y = res, color = dist)) +
  geom_point()


plot(fitted(lme1),residuals(lme1))
```

*!!!! Visual  inspection  of  residual plots  did  reveal obvious  deviations  from  homoscedasticity  or normality !!!!!*


### [45,75)

```{r model2, echo=FALSE}
#"[25,45)", "[45,75)", "[75,115)", "[115,155)", "[155,210)"

dataset_f <- dataset %>% filter(dist_short == "[45,75)")

lme1 <- lmer(diff ~ km_effort  + (1 | id)  , data = dataset_f, REML = FALSE)
lme1.null <- lmer(diff ~ 1  + (1 | id), data = dataset_f, REML = FALSE)

rslt <- anova(lme1.null, lme1)

pander(rslt)

summary(lme1)
```


```{r model2_variance, echo=FALSE}

plot(fitted(lme1),residuals(lme1))
```

*!!!! Visual  inspection  of  residual plots  did  reveal obvious  deviations  from  homoscedasticity  or normality !!!!!*

### [75,115)

```{r model3, echo=FALSE}
#"[25,45)", "[45,75)", "[75,115)", "[115,155)", "[155,210)"

dataset_f <- dataset %>% filter(dist_short == "[75,115)")

lme1 <- lmer(diff ~ km_effort  + (1 | id)  , data = dataset_f, REML = FALSE)
lme1.null <- lmer(diff ~ 1  + (1 | id), data = dataset_f, REML = FALSE)

rslt <- anova(lme1.null, lme1)

pander(rslt)

summary(lme1)
```


```{r model3_variance, echo=FALSE}

plot(fitted(lme1),residuals(lme1))
```

*!!!! Visual  inspection  of  residual plots  did  reveal obvious  deviations  from  homoscedasticity  or normality !!!!!*

### [115,155)

```{r model4, echo=FALSE}
#"[25,45)", "[45,75)", "[75,115)", "[115,155)", "[155,210)"

dataset_f <- dataset %>% filter(dist_short == "[115,155)")

lme1 <- lmer(diff ~ km_effort  + (1 | id)  , data = dataset_f, REML = FALSE)
lme1.null <- lmer(diff ~ 1  + (1 | id), data = dataset_f, REML = FALSE)

rslt <- anova(lme1.null, lme1)

pander(rslt)

summary(lme1)
```


```{r model4_variance, echo=FALSE}

plot(fitted(lme1),residuals(lme1))
```

*!!!! Visual  inspection  of  residual plots  did  reveal obvious  deviations  from  homoscedasticity  or normality !!!!!*

### [155,210)

```{r model5, echo=FALSE}
#"[25,45)", "[45,75)", "[75,115)", "[115,155)", "[155,210)"

dataset_f <- dataset %>% filter(dist_short == "[155,210)")

lme1 <- lmer(diff ~ km_effort  + (1 | id)  , data = dataset_f, REML = FALSE)
lme1.null <- lmer(diff ~ 1  + (1 | id), data = dataset_f, REML = FALSE)

rslt <- anova(lme1.null, lme1)

pander(rslt)

summary(lme1)
```


```{r model5_variance, echo=FALSE}

plot(fitted(lme1),residuals(lme1))
```

*!!!! Visual  inspection  of  residual plots  did  reveal obvious  deviations  from  homoscedasticity  or normality !!!!!*